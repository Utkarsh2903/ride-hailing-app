#!/usr/bin/env bash
# Setup script for Ride Hailing App

set -e  # Exit on error

echo "ðŸš€ Ride Hailing App - Local Setup"
echo "=================================="
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
success() {
  echo -e "${GREEN}âœ… $1${NC}"
}

error() {
  echo -e "${RED}âŒ $1${NC}"
}

warning() {
  echo -e "${YELLOW}âš ï¸  $1${NC}"
}

info() {
  echo -e "${YELLOW}â„¹ï¸  $1${NC}"
}

# Check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

echo "Step 1: Checking System Dependencies"
echo "-------------------------------------"

# Check Ruby
if command_exists ruby; then
  RUBY_VERSION=$(ruby -v | awk '{print $2}')
  success "Ruby $RUBY_VERSION installed"
else
  error "Ruby not found"
  info "Install Ruby using: brew install rbenv ruby-build"
  info "Then: rbenv install 3.2.2 && rbenv global 3.2.2"
  exit 1
fi

# Check Bundler
if command_exists bundle; then
  success "Bundler installed"
else
  info "Installing Bundler..."
  gem install bundler
  success "Bundler installed"
fi

# Check PostgreSQL
if command_exists psql; then
  PG_VERSION=$(psql --version | awk '{print $3}')
  success "PostgreSQL $PG_VERSION installed"
else
  error "PostgreSQL not found"
  info "Install with: brew install postgresql@16"
  exit 1
fi

# Check PostGIS
if psql -d postgres -c "SELECT PostGIS_Version();" >/dev/null 2>&1; then
  success "PostGIS extension available"
else
  error "PostGIS not found"
  info "Install with: brew install postgis"
  info "Then enable in PostgreSQL: psql -d postgres -c 'CREATE EXTENSION postgis;'"
  exit 1
fi

# Check Redis
if command_exists redis-cli; then
  success "Redis installed"
  if redis-cli ping >/dev/null 2>&1; then
    success "Redis is running"
  else
    warning "Redis is not running"
    info "Starting Redis..."
    brew services start redis
    sleep 2
    if redis-cli ping >/dev/null 2>&1; then
      success "Redis started"
    else
      error "Failed to start Redis"
      exit 1
    fi
  fi
else
  error "Redis not found"
  info "Install with: brew install redis"
  exit 1
fi

echo ""
echo "Step 2: Installing Ruby Dependencies"
echo "------------------------------------"

if bundle check >/dev/null 2>&1; then
  success "All gems already installed"
else
  info "Installing gems..."
  bundle install
  success "Gems installed"
fi

echo ""
echo "Step 3: Setting Up Database"
echo "---------------------------"

# Check if database exists
if bundle exec rails runner "ActiveRecord::Base.connection" >/dev/null 2>&1; then
  success "Database already exists"
else
  info "Creating databases..."
  bundle exec rails db:create
  success "Databases created"
fi

# Run migrations
info "Running migrations..."
bundle exec rails db:migrate
success "Migrations completed"

# Check migration status
PENDING=$(bundle exec rails db:migrate:status 2>/dev/null | grep "down" | wc -l)
if [ "$PENDING" -eq 0 ]; then
  success "All migrations are up to date"
else
  warning "$PENDING pending migrations found"
fi

echo ""
echo "Step 4: Setting Up Credentials"
echo "-------------------------------"

if [ -f "config/master.key" ]; then
  success "Master key exists"
else
  warning "Master key not found"
  info "Creating credentials file..."
  EDITOR="echo" bundle exec rails credentials:edit >/dev/null 2>&1
  success "Credentials file created"
fi

echo ""
echo "Step 5: Seeding Database (Optional)"
echo "-----------------------------------"

USER_COUNT=$(bundle exec rails runner "puts User.count" 2>/dev/null)
if [ "$USER_COUNT" -gt 0 ]; then
  success "Database has data ($USER_COUNT users)"
else
  info "Database is empty"
  if [ -f "db/seeds.rb" ]; then
    read -p "Would you like to seed the database? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      info "Seeding database..."
      bundle exec rails db:seed
      success "Database seeded"
    fi
  else
    info "No seed file found (db/seeds.rb)"
  fi
fi

echo ""
echo "Step 6: Health Checks"
echo "--------------------"

# Check Redis
if bundle exec rails runner "puts \$redis.ping" 2>/dev/null | grep -q "PONG"; then
  success "Redis connection working"
else
  error "Redis connection failed"
fi

# Check Database
if bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" >/dev/null 2>&1; then
  success "Database connection working"
else
  error "Database connection failed"
fi

# Check PostGIS
if bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT PostGIS_Version()')" >/dev/null 2>&1; then
  success "PostGIS extension working"
else
  error "PostGIS extension not available"
fi

echo ""
echo "=================================="
echo "âœ… Setup Complete!"
echo "=================================="
echo ""
echo "ðŸŽ‰ Your local environment is ready!"
echo ""
echo "Next steps:"
echo ""
echo "1. Start Rails server:"
echo "   $ rails server"
echo ""
echo "2. Start Sidekiq (in another terminal):"
echo "   $ bundle exec sidekiq"
echo ""
echo "3. Test the application:"
echo "   Visit: http://localhost:3000/up"
echo ""
echo "4. Check the setup guide:"
echo "   See: LOCAL_SETUP.md"
echo ""
echo "Happy coding! ðŸš€"
echo ""
