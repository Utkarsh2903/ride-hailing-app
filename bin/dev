#!/usr/bin/env bash
# Development server starter

set -e

echo "üöÄ Starting Ride Hailing App Development Environment"
echo ""

# Check if services are running
echo "Checking services..."

# Check PostgreSQL
if ! brew services list | grep -q "postgresql@16.*started"; then
  echo "üì¶ Starting PostgreSQL..."
  brew services start postgresql@16
  sleep 2
fi

# Check Redis
if ! redis-cli ping > /dev/null 2>&1; then
  echo "üì¶ Starting Redis..."
  brew services start redis
  sleep 2
fi

echo "‚úÖ All services running!"
echo ""
echo "Starting application..."
echo ""
echo "This will start:"
echo "  - Rails server on http://localhost:3000"
echo "  - Sidekiq for background jobs"
echo ""
echo "Press Ctrl+C to stop all processes"
echo ""

# Function to cleanup on exit
cleanup() {
  echo ""
  echo "Stopping services..."
  kill 0
  exit
}

trap cleanup SIGINT SIGTERM

# Start Rails and Sidekiq in background
bundle exec rails server &
RAILS_PID=$!

bundle exec sidekiq &
SIDEKIQ_PID=$!

echo "‚úÖ Rails server started (PID: $RAILS_PID)"
echo "‚úÖ Sidekiq started (PID: $SIDEKIQ_PID)"
echo ""
echo "üìù View logs:"
echo "   tail -f log/development.log"
echo ""

# Wait for processes
wait

