#!/usr/bin/env bash
# Railway Deployment Script for Ride Hailing App

set -e

echo "ğŸš‚ Railway Deployment Script"
echo "============================"
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

success() { echo -e "${GREEN}âœ… $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }
info() { echo -e "${YELLOW}â„¹ï¸  $1${NC}"; }

# Check if Railway CLI is installed
if ! command -v railway &> /dev/null; then
    error "Railway CLI not found"
    info "Install with: brew install railway"
    exit 1
fi

success "Railway CLI found"

# Check if logged in
if ! railway whoami &> /dev/null; then
    info "You need to login to Railway"
    railway login
fi

success "Logged in to Railway"

# Check if project is initialized
if [ ! -f ".railway" ]; then
    info "Initializing Railway project..."
    railway init
    success "Project initialized"
else
    success "Railway project already initialized"
fi

echo ""
echo "Step 1: Adding Databases"
echo "------------------------"

# Add PostgreSQL
info "Adding PostgreSQL database..."
if railway add --database postgres --yes 2>/dev/null; then
    success "PostgreSQL added"
else
    info "PostgreSQL might already exist"
fi

# Add Redis
info "Adding Redis database..."
if railway add --database redis --yes 2>/dev/null; then
    success "Redis added"
else
    info "Redis might already exist"
fi

echo ""
echo "Step 2: Setting Environment Variables"
echo "-------------------------------------"

# Check if master key exists
if [ ! -f "config/master.key" ]; then
    error "config/master.key not found"
    info "Generate with: EDITOR='echo' rails credentials:edit"
    exit 1
fi

# Set environment variables
info "Setting RAILS_MASTER_KEY..."
railway variables --set RAILS_MASTER_KEY="$(cat config/master.key)"
success "RAILS_MASTER_KEY set"

info "Setting RAILS_ENV..."
railway variables --set RAILS_ENV=production
success "RAILS_ENV set"

info "Setting RACK_ENV..."
railway variables --set RACK_ENV=production
success "RACK_ENV set"

info "Setting SECRET_KEY_BASE..."
SECRET_KEY=$(openssl rand -hex 64)
railway variables --set SECRET_KEY_BASE="$SECRET_KEY"
success "SECRET_KEY_BASE set"

info "Setting RAILS_SERVE_STATIC_FILES..."
railway variables --set RAILS_SERVE_STATIC_FILES=true
success "RAILS_SERVE_STATIC_FILES set"

echo ""
echo "Step 3: Committing Changes"
echo "--------------------------"

# Check if there are uncommitted changes
if [[ -n $(git status -s) ]]; then
    info "Uncommitted changes found. Committing..."
    git add .
    git commit -m "Deploy to Railway - $(date +%Y-%m-%d_%H:%M:%S)"
    success "Changes committed"
else
    success "No uncommitted changes"
fi

echo ""
echo "Step 4: Deploying to Railway"
echo "----------------------------"

info "Starting deployment..."
railway up

success "Deployment triggered!"

echo ""
echo "Step 5: Running Migrations"
echo "-------------------------"

info "Waiting for deployment to complete (30 seconds)..."
sleep 30

info "Running database migrations..."
railway run rails db:migrate

success "Migrations completed"

echo ""
echo "Step 6: Enabling PostGIS"
echo "-----------------------"

info "Enabling PostGIS extension..."
railway run rails runner "ActiveRecord::Base.connection.execute('CREATE EXTENSION IF NOT EXISTS postgis')" || info "PostGIS might already be enabled"

success "PostGIS enabled"

echo ""
echo "Step 7: Seeding Database (Optional)"
echo "-----------------------------------"

read -p "Do you want to seed the database? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    info "Seeding database..."
    railway run rails db:seed
    success "Database seeded"
else
    info "Skipping database seed"
fi

echo ""
echo "=============================="
echo "ğŸ‰ Deployment Complete!"
echo "=============================="
echo ""

# Get the app URL
info "Getting your app URL..."
APP_URL=$(railway domain 2>/dev/null || echo "Run 'railway domain' to get your URL")

echo ""
echo "Your app is deployed! ğŸš€"
echo ""
echo "ğŸ“ App URL: $APP_URL"
echo ""
echo "Useful commands:"
echo "  â€¢ View logs:        railway logs"
echo "  â€¢ Open app:         railway open"
echo "  â€¢ Run console:      railway run rails console"
echo "  â€¢ Check variables:  railway variables"
echo "  â€¢ SSH into app:     railway shell"
echo ""
echo "Test your app:"
echo "  curl ${APP_URL}/up"
echo ""
echo "Happy coding! ğŸ‰"

